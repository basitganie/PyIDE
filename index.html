<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Code Editor - Basit Ahmad Ganie</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --text-primary: #d4d4d4;
            --text-secondary: #858585;
            --border-color: #333;
            --accent-blue: #0e639c;
            --accent-green: #4ec9b0;
            --accent-red: #f44747;
            --accent-yellow: #ffcc02;
            --vim-bg: #0c0c0c;
            --vim-fg: #00ff00;
            --vim-accent: #ff6600;
        }

        body {
            font-family: 'Fira Code', 'Cascadia Code', 'SF Mono', monospace;
            margin: 0;
            padding: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* File Tabs */
        .tabs-container {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            min-height: 40px;
        }

        .file-tabs {
            display: flex;
            flex: 1;
            overflow-x: auto;
            scroll-behavior: smooth;
        }

        .file-tab {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            padding: 8px 16px 8px 12px;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            transition: all 0.2s ease;
            position: relative;
            min-width: 120px;
            max-width: 200px;
        }

        .file-tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-blue);
        }

        .file-tab:hover:not(.active) {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .file-tab .close-btn {
            opacity: 0;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            transition: opacity 0.2s;
            color: var(--text-secondary);
        }

        .file-tab:hover .close-btn,
        .file-tab.active .close-btn {
            opacity: 1;
        }

        .file-tab .close-btn:hover {
            color: var(--accent-red);
        }

        .new-file-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            font-size: 16px;
            transition: color 0.2s;
        }

        .new-file-btn:hover {
            color: var(--text-primary);
        }

        /* Editor Layout */
        .editor-layout {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-container {
            flex: 1;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .editor-header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 32px;
        }

        .editor-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
        }

        .line-numbers {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 15px 8px;
            text-align: right;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 21px;
            min-width: 50px;
            border-right: 1px solid var(--border-color);
            user-select: none;
            overflow: hidden;
            white-space: pre;
        }

        .code-editor {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #code-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 21px;
            padding: 15px;
            border: none;
            resize: none;
            background: transparent;
            color: transparent;
            caret-color: var(--text-primary);
            tab-size: 4;
            outline: none;
            white-space: pre;
            overflow: auto;
            z-index: 2;
            box-sizing: border-box;
        }

        #code-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 15px;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 21px;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: auto;
            pointer-events: none;
            z-index: 1;
            white-space: pre;
            box-sizing: border-box;
        }

        /* Controls */
        .controls {
            background: var(--bg-secondary);
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        button:hover {
            background: #1177bb;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        #clear-btn {
            background: #5a5a5a;
        }

        #clear-btn:hover {
            background: #6a6a6a;
        }

        .btn-group {
            display: flex;
            gap: 5px;
        }

        /* Output Panel */
        .output-container {
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 250px;
            min-height: 150px;
            max-height: 400px;
            resize: vertical;
            overflow: hidden;
        }

        .output-header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            min-height: 32px;
        }

        #output {
            flex: 1;
            padding: 15px;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-y: auto;
            border: none;
            outline: none;
        }

        /* Themes */
        .theme-selector, select, input[type="text"] {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
        }

        /* Vim Theme */
        .vim-theme {
            --bg-primary: var(--vim-bg);
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: var(--vim-fg);
            --text-secondary: #00cc00;
            --border-color: #333;
            --accent-blue: var(--vim-accent);
        }

        /* Light Theme */
        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #ddd;
            --accent-blue: #0066cc;
        }

        /* Status and Loading */
        .status-bar {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 4px 15px;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            color: var(--accent-blue);
            font-style: italic;
        }

        .error-highlight {
            background-color: rgba(244, 71, 71, 0.2);
            border-left: 3px solid var(--accent-red);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 6px;
            border: 2px solid var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-primary);
        }

        /* Font controls */
        .font-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .font-controls button {
            padding: 2px 6px;
            font-size: 12px;
            min-width: 24px;
        }

        /* File rename input */
        .file-rename-input {
            background: var(--bg-primary);
            border: 1px solid var(--accent-blue);
            color: var(--text-primary);
            padding: 2px 6px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            border-radius: 2px;
        }

        /* Minimap (placeholder for future) */
        .minimap {
            width: 100px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: none; /* Hidden for now */
        }

        /* Responsive */
        @media (max-width: 768px) {
            .controls {
                padding: 8px;
                gap: 5px;
            }
            
            .file-tab {
                min-width: 100px;
                padding: 6px 12px 6px 8px;
            }
            
            .output-container {
                height: 200px;
            }
        }

        /* Custom context menu (future enhancement) */
        .context-menu {
            position: absolute;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
        }

        .context-menu-item:hover {
            background: var(--accent-blue);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- File Tabs -->
        <div class="tabs-container">
            <div class="file-tabs" id="file-tabs"></div>
            <button class="new-file-btn" id="new-file-btn" title="New File (Ctrl+N)">+</button>
        </div>

        <!-- Editor Layout -->
        <div class="editor-layout">
            <div class="editor-container">
                <div class="editor-header">
                    <div class="header-controls">
                        <select id="examples-dropdown" title="Load Example">
                            <option value="">Load Example</option>
                            <option value="hello">Hello World</option>
                            <option value="loop">Loops & Functions</option>
                            <option value="class">Class Example</option>
                            <option value="numpy">NumPy Example</option>
                            <option value="web">Web Scraping</option>
                            <option value="data">Data Analysis</option>
                        </select>
                        <div class="font-controls">
                            <button id="decrease-font" title="Decrease Font Size">A-</button>
                            <button id="increase-font" title="Increase Font Size">A+</button>
                        </div>
                    </div>
                    <select class="theme-selector" id="theme-selector">
                        <option value="dark">Dark Theme</option>
                        <option value="vim">Vim Theme</option>
                        <option value="light">Light Theme</option>
                    </select>
                </div>
                
                <div class="editor-wrapper">
                    <div class="line-numbers" id="line-numbers"></div>
                    <div class="code-editor">
                        <textarea id="code-input" spellcheck="false" placeholder="Start typing your Python code here..."></textarea>
                        <pre id="code-highlight"><code class="language-python"></code></pre>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <div class="btn-group">
                <button id="run-btn" title="Run Code (Ctrl+Enter)">‚ñ∂Ô∏è Run</button>
                <button id="stop-btn" title="Stop Execution" style="display: none;">‚èπ Stop</button>
            </div>
            <div class="btn-group">
                <button id="save-btn" title="Save Current File (Ctrl+S)">üíæ Save</button>
                <button id="load-btn" title="Load File">üìÇ Load</button>
                <button id="export-all-btn" title="Export All Files">üì¶ Export All</button>
            </div>
            <div class="btn-group">
                <button id="share-btn" title="Generate Share Link">üîó Share</button>
                <button id="clear-btn" title="Clear Output">üóëÔ∏è Clear</button>
            </div>
            <span id="status" class="status">Initializing Python...</span>
        </div>
        
        <!-- Output Panel -->
        <div class="output-container">
            <div class="output-header">
                <span>Output</span>
                <div class="btn-group">
                    <button id="copy-output-btn" style="padding: 4px 8px; font-size: 12px;" title="Copy Output">üìã Copy</button>
                    <button id="clear-output-btn" style="padding: 4px 8px; font-size: 12px;" title="Clear Output">üóëÔ∏è</button>
                </div>
            </div>
            <div id="output"></div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <span id="status-left">Ready</span>
            <span id="status-right">Python | UTF-8 | Ln 1, Col 1 | shell: basit@localhost</span>
        </div>
        
        <input type="file" id="file-input" style="display: none" accept=".py,.txt,.md">
        <div id="loading" class="loading" style="display: none;">Loading Python runtime...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>

    <script>
        // File management system
        class FileManager {
            constructor() {
                this.files = {};
                this.activeFile = null;
                this.fileCounter = 0;
                this.createDefaultFile();
            }
            
            createDefaultFile() {
                const defaultCode = `# Welcome to Enhanced Python Editor
"""Author: Basit Ahmad Ganie"""

# Try writing some Python code here
def greet(name):
    """A simple greeting function"""
    return f"Hello, {name}!"

print(greet("Basit"))

# Testing multiple lines
for i in range(5):
    print(f"Count: {i}")

# Math operations
x = 5 + 3
print(f"5 + 3 = {x}")

# List comprehension
squares = [x**2 for x in range(10)]
print(f"Squares: {squares}")
`;
                this.createFile('main.py', defaultCode);
                this.setActiveFile('main.py');
            }
            
            createFile(name = null, content = '') {
                if (!name) {
                    this.fileCounter++;
                    name = `untitled-${this.fileCounter}.py`;
                }
                
                // Ensure unique name
                let finalName = name;
                let counter = 1;
                while (this.files[finalName]) {
                    const parts = name.split('.');
                    const ext = parts.pop();
                    const baseName = parts.join('.');
                    finalName = `${baseName}-${counter}.${ext}`;
                    counter++;
                }
                
                this.files[finalName] = {
                    content: content,
                    modified: false,
                    cursor: { line: 1, col: 1 }
                };
                
                return finalName;
            }
            
            deleteFile(name) {
                if (Object.keys(this.files).length <= 1) {
                    alert('Cannot delete the last file');
                    return false;
                }
                
                delete this.files[name];
                
                if (this.activeFile === name) {
                    const remainingFiles = Object.keys(this.files);
                    this.setActiveFile(remainingFiles[0]);
                }
                
                return true;
            }
            
            setActiveFile(name) {
                if (!this.files[name]) return false;
                
                // Save current cursor position
                if (this.activeFile && this.files[this.activeFile]) {
                    const textarea = document.getElementById('code-input');
                    this.files[this.activeFile].cursor = this.getCursorPosition();
                }
                
                this.activeFile = name;
                return true;
            }
            
            getActiveFile() {
                return this.files[this.activeFile];
            }
            
            updateFileContent(name, content) {
                if (this.files[name]) {
                    this.files[name].content = content;
                    this.files[name].modified = true;
                }
            }
            
            getCursorPosition() {
                const textarea = document.getElementById('code-input');
                const start = textarea.selectionStart;
                const text = textarea.value.substring(0, start);
                const lines = text.split('\n');
                return {
                    line: lines.length,
                    col: lines[lines.length - 1].length + 1
                };
            }
            
            renameFile(oldName, newName) {
                if (!this.files[oldName] || this.files[newName]) return false;
                
                this.files[newName] = this.files[oldName];
                delete this.files[oldName];
                
                if (this.activeFile === oldName) {
                    this.activeFile = newName;
                }
                
                return true;
            }
        }

        // Enhanced code examples
        const codeExamples = {
            hello: `# Hello World Example
print("Hello, World!")

# String manipulation
name = "Basit"
print(f"Hello, {name}!")
print("Hello, " + name + "!")

# Multiple lines with newline characters
print("Line 1\\nLine 2\\nLine 3")

# Testing end parameter
print("This", end=" ")
print("will", end=" ")
print("be", end=" ")
print("on", end=" ")
print("one", end=" ")
print("line.")`,

            loop: `# Loops and Functions Example
def factorial(n):
    """Calculate factorial of n"""
    if n == 0 or n == 1:
        return 1
    else:
        return n * factorial(n-1)

# Testing the factorial function
for i in range(10):
    print(f"Factorial of {i} is {factorial(i)}")

# List comprehension with conditional
even_squares = [x**2 for x in range(20) if x % 2 == 0]
print(f"Even squares: {even_squares}")

# While loop with a break
count = 0
while True:
    print(f"Count: {count}")
    count += 1
    if count >= 5:
        print("Breaking out of loop")
        break`,

            class: `# Class Example
class Person:
    def __init__(self, name, age):
        self.name = name
        self.age = age
        
    def greet(self):
        return f"Hello, my name is {self.name} and I am {self.age} years old."
    
    def have_birthday(self):
        self.age += 1
        return f"Happy Birthday! Now {self.name} is {self.age} years old."

# Create some people
basit = Person("Basit", 20)
max_e = Person("Max", 19)

# Use the Person class
print(basit.greet())
print(max_e.greet())
print(basit.have_birthday())
print(max_e.have_birthday())`,

            numpy: `# NumPy Example
import numpy as np

# Create arrays
arr = np.array([1, 2, 3, 4, 5])
print(f"Array: {arr}")
print(f"Mean: {np.mean(arr)}")
print(f"Standard deviation: {np.std(arr)}")

# Matrix operations
matrix1 = np.array([[1, 2], [3, 4]])
matrix2 = np.array([[5, 6], [7, 8]])

print(f"Matrix 1:\\n{matrix1}")
print(f"Matrix 2:\\n{matrix2}")
print(f"Addition:\\n{matrix1 + matrix2}")
print(f"Dot product:\\n{np.dot(matrix1, matrix2)}")

# Random numbers
random_array = np.random.rand(3, 3)
print(f"Random 3x3 matrix:\\n{random_array}")

# Linear algebra
eigenvals, eigenvecs = np.linalg.eig(matrix1)
print(f"Eigenvalues: {eigenvals}")`,

            web: `# Web Scraping Example (simulated)
# Note: This is a demonstration of web scraping concepts
# In a real environment, you would need requests and BeautifulSoup

# Simulated web data
html_content = '''
<html>
<body>
    <h1>Welcome to Python</h1>
    <p>This is a paragraph.</p>
    <ul>
        <li>Item 1</li>
        <li>Item 2</li>
        <li>Item 3</li>
    </ul>
</body>
</html>
'''

# Simple HTML parsing (basic example)
import re

# Extract title
title_match = re.search(r'<h1>(.*?)</h1>', html_content)
if title_match:
    print(f"Title: {title_match.group(1)}")

# Extract list items
items = re.findall(r'<li>(.*?)</li>', html_content)
print("List items:")
for i, item in enumerate(items, 1):
    print(f"  {i}. {item}")`,

            data: `# Data Analysis Example
import numpy as np

# Create sample data
data = np.array([23, 45, 56, 78, 32, 67, 89, 12, 34, 56, 78, 90, 23, 45])
print(f"Sample data: {data}")

# Basic statistics
print(f"Mean: {np.mean(data):.2f}")
print(f"Median: {np.median(data):.2f}")
print(f"Standard Deviation: {np.std(data):.2f}")
print(f"Min: {np.min(data)}")
print(f"Max: {np.max(data)}")

# Quartiles
q1 = np.percentile(data, 25)
q3 = np.percentile(data, 75)
print(f"Q1: {q1:.2f}")
print(f"Q3: {q3:.2f}")
print(f"IQR: {q3 - q1:.2f}")

# Data transformation
normalized_data = (data - np.mean(data)) / np.std(data)
print(f"Normalized data: {normalized_data}")

# Simple correlation (with itself, just for demo)
correlation = np.corrcoef(data, data**2)[0, 1]
print(f"Correlation with squares: {correlation:.3f}")`
        };

        // Global variables
        let pyodide;
        let currentFontSize = 14;
        let fileManager;
        let isRunning = false;

        // DOM elements
        const elements = {
            codeInput: document.getElementById('code-input'),
            codeHighlight: document.getElementById('code-highlight').querySelector('code'),
            output: document.getElementById('output'),
            lineNumbers: document.getElementById('line-numbers'),
            fileTabs: document.getElementById('file-tabs'),
            statusLeft: document.getElementById('status-left'),
            statusRight: document.getElementById('status-right'),
            themeSelector: document.getElementById('theme-selector'),
            examplesDropdown: document.getElementById('examples-dropdown')
        };

        // File tab management
        function renderFileTabs() {
            elements.fileTabs.innerHTML = '';
            
            Object.keys(fileManager.files).forEach(fileName => {
                const tab = document.createElement('div');
                tab.className = `file-tab ${fileName === fileManager.activeFile ? 'active' : ''}`;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = fileName + (fileManager.files[fileName].modified ? '*' : '');
                nameSpan.className = 'file-name';
                
                const closeBtn = document.createElement('span');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '√ó';
                closeBtn.onclick = (e) => {
                    e.stopPropagation();
                    closeFile(fileName);
                };
                
                tab.appendChild(nameSpan);
                tab.appendChild(closeBtn);
                
                tab.onclick = () => switchToFile(fileName);
                
                // Double click to rename
                nameSpan.ondblclick = (e) => {
                    e.stopPropagation();
                    startFileRename(fileName, nameSpan);
                };
                
                elements.fileTabs.appendChild(tab);
            });
        }

        function switchToFile(fileName) {
            if (fileManager.setActiveFile(fileName)) {
                const file = fileManager.getActiveFile();
                elements.codeInput.value = file.content;
                
                // Restore cursor position
                setTimeout(() => {
                    const pos = getTextPosition(file.cursor.line, file.cursor.col);
                    elements.codeInput.setSelectionRange(pos, pos);
                    elements.codeInput.focus();
                }, 0);
                
                updateEditor();
                renderFileTabs();
            }
        }

        function closeFile(fileName) {
            if (fileManager.deleteFile(fileName)) {
                renderFileTabs();
                switchToFile(fileManager.activeFile);
            }
        }

        function createNewFile() {
            const fileName = fileManager.createFile();
            switchToFile(fileName);
            renderFileTabs();
        }

        function startFileRename(fileName, nameElement) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'file-rename-input';
            input.value = fileName;
            input.style.width = '120px';
            
            nameElement.replaceWith(input);
            input.focus();
            input.select();
            
            function finishRename() {
                const newName = input.value.trim();
                if (newName && newName !== fileName && !fileManager.files[newName]) {
                    if (fileManager.renameFile(fileName, newName)) {
                        renderFileTabs();
                        return;
                    }
                }
                renderFileTabs();
            }
            
            input.onblur = finishRename;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    finishRename();
                } else if (e.key === 'Escape') {
                    renderFileTabs();
                }
            };
        }

        // Helper function to convert line/col to text position
        function getTextPosition(line, col) {
            const lines = elements.codeInput.value.split('\n');
            let pos = 0;
            for (let i = 0; i < Math.min(line - 1, lines.length); i++) {
                pos += lines[i].length + 1; // +1 for newline
            }
            pos += Math.min(col - 1, lines[line - 1]?.length || 0);
            return pos;
        }

        // Update line numbers and syntax highlighting
        function updateEditor() {
            const code = elements.codeInput.value;
            const lines = code.split('\n');
            
            // Update line numbers with proper alignment
            const lineCount = Math.max(lines.length, 1);
            const maxDigits = lineCount.toString().length;
            
            elements.lineNumbers.innerHTML = lines.map((_, i) => {
                const lineNum = (i + 1).toString().padStart(maxDigits, ' ');
                return `${lineNum}`;
            }).join('\n');
            
            // Update syntax highlighting
            elements.codeHighlight.textContent = code;
            Prism.highlightElement(elements.codeHighlight);
            
            // Sync scroll positions
            syncScroll();
            
            // Update file content
            if (fileManager.activeFile) {
                fileManager.updateFileContent(fileManager.activeFile, code);
                renderFileTabs();
            }
            
            // Update cursor position in status bar
            updateCursorStatus();
        }

        function syncScroll() {
            const codeHighlightContainer = document.getElementById('code-highlight');
            codeHighlightContainer.scrollTop = elements.codeInput.scrollTop;
            codeHighlightContainer.scrollLeft = elements.codeInput.scrollLeft;
            elements.lineNumbers.scrollTop = elements.codeInput.scrollTop;
        }

        function updateCursorStatus() {
            const pos = fileManager.getCursorPosition();
            const charCount = elements.codeInput.value.length;
            const selectedText = elements.codeInput.value.substring(
                elements.codeInput.selectionStart, 
                elements.codeInput.selectionEnd
            );
            
            let statusText = `Python | UTF-8 | Ln ${pos.line}, Col ${pos.col}`;
            if (selectedText.length > 0) {
                statusText += ` | ${selectedText.length} selected`;
            }
            statusText += ` | ${charCount} chars`;
            
            elements.statusRight.textContent = statusText;
        }

        // Initialize Pyodide
        async function initializePyodide() {
            const loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'block';
            elements.statusLeft.textContent = 'Initializing Python runtime...';
            
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                });
                
                // Setup output redirection
                function updateOutput(text) {
                    elements.output.textContent = text;
                    elements.output.scrollTop = elements.output.scrollHeight;
                }
                
                pyodide.globals.set("js_update_output", updateOutput);
                
                await pyodide.runPythonAsync(`
                    import sys
                    import io
                    
                    class CustomOutput:
                        def __init__(self):
                            self.buffer = ""
                        
                        def write(self, text):
                            self.buffer += text
                            js_update_output(self.buffer)
                            return len(text)
                        
                        def flush(self):
                            pass
                        
                        def clear(self):
                            self.buffer = ""
                            js_update_output(self.buffer)
                    
                    stdout_capture = CustomOutput()
                    stderr_capture = CustomOutput()
                    sys.stdout = stdout_capture
                    sys.stderr = stderr_capture
                `);
                
                // Load common packages
                await pyodide.loadPackage(['numpy', 'micropip']);
                
                elements.statusLeft.textContent = 'Ready';
                document.getElementById('run-btn').disabled = false;
                
            } catch (err) {
                elements.statusLeft.textContent = 'Failed to initialize';
                elements.output.textContent = `Initialization Error: ${err}\n`;
                console.error('Pyodide initialization failed:', err);
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // Run Python code
        async function runPython() {
            if (isRunning) return;
            
            const code = elements.codeInput.value;
            if (!code.trim()) return;
            
            isRunning = true;
            elements.statusLeft.textContent = 'Running...';
            document.getElementById('run-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-flex';
            
            try {
                // Clear previous output
                await pyodide.runPythonAsync(`
                    sys.stdout.clear()
                    sys.stderr.clear()
                `);
                
                // Run user code
                await pyodide.runPythonAsync(code);
                elements.statusLeft.textContent = 'Execution completed';
                
            } catch (err) {
                // Handle Python errors
                elements.output.textContent += `\n‚ùå Error: ${err}\n`;
                elements.statusLeft.textContent = 'Execution failed';
                highlightErrorLine(err);
                
            } finally {
                isRunning = false;
                document.getElementById('run-btn').style.display = 'inline-flex';
                document.getElementById('stop-btn').style.display = 'none';
            }
        }

        function stopExecution() {
            // Note: Actually stopping Python execution is complex
            // This is a placeholder for the UI
            isRunning = false;
            document.getElementById('run-btn').style.display = 'inline-flex';
            document.getElementById('stop-btn').style.display = 'none';
            elements.statusLeft.textContent = 'Execution stopped';
        }

        function highlightErrorLine(error) {
            // Remove previous highlights
            const lines = elements.lineNumbers.querySelectorAll('.error-highlight');
            lines.forEach(line => line.classList.remove('error-highlight'));
            
            // Try to extract line number from error
            const match = error.toString().match(/line (\d+)/);
            if (match) {
                const lineNum = parseInt(match[1]);
                const lineElements = elements.lineNumbers.children;
                if (lineElements[lineNum - 1]) {
                    lineElements[lineNum - 1].classList.add('error-highlight');
                    
                    // Scroll to error line
                    const lineHeight = 21; // matches CSS line-height
                    elements.codeInput.scrollTop = Math.max(0, (lineNum - 3) * lineHeight);
                }
            }
        }

        // File operations
        function saveCurrentFile() {
            const fileName = fileManager.activeFile;
            const content = elements.codeInput.value;
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
            
            // Mark file as saved
            fileManager.files[fileName].modified = false;
            renderFileTabs();
            elements.statusLeft.textContent = `Saved ${fileName}`;
        }

        function loadFromFile() {
            document.getElementById('file-input').click();
        }

        function exportAllFiles() {
            const zip = {};
            Object.keys(fileManager.files).forEach(fileName => {
                zip[fileName] = fileManager.files[fileName].content;
            });
            
            const content = JSON.stringify(zip, null, 2);
            const blob = new Blob([content], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'python_project.json';
            a.click();
            URL.revokeObjectURL(a.href);
            
            elements.statusLeft.textContent = 'All files exported';
        }

        // File input handler
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    
                    // Try to parse as JSON (exported project)
                    try {
                        const parsed = JSON.parse(content);
                        if (typeof parsed === 'object') {
                            // Load multiple files
                            Object.keys(parsed).forEach(fileName => {
                                fileManager.createFile(fileName, parsed[fileName]);
                            });
                            switchToFile(Object.keys(parsed)[0]);
                            renderFileTabs();
                            elements.statusLeft.textContent = 'Project loaded';
                            return;
                        }
                    } catch (e) {
                        // Not JSON, treat as single file
                    }
                    
                    // Single file
                    const fileName = file.name || 'imported.py';
                    const newFileName = fileManager.createFile(fileName, content);
                    switchToFile(newFileName);
                    renderFileTabs();
                    elements.statusLeft.textContent = `Loaded ${fileName}`;
                };
                reader.readAsText(file);
            }
        });

        // Share functionality
        function shareCode() {
            const allFiles = {};
            Object.keys(fileManager.files).forEach(fileName => {
                allFiles[fileName] = fileManager.files[fileName].content;
            });
            
            const data = {
                files: allFiles,
                active: fileManager.activeFile
            };
            
            const encoded = encodeURIComponent(JSON.stringify(data));
            const url = `${window.location.href.split('?')[0]}?data=${encoded}`;
            
            navigator.clipboard.writeText(url).then(() => {
                elements.statusLeft.textContent = 'Share link copied to clipboard';
                setTimeout(() => {
                    elements.statusLeft.textContent = 'Ready';
                }, 3000);
            }).catch(err => {
                elements.statusLeft.textContent = 'Failed to copy share link';
                console.error('Failed to copy:', err);
            });
        }

        // Theme management
        function changeTheme(theme) {
            // Remove existing theme classes
            document.body.classList.remove('vim-theme', 'light-theme');
            
            // Apply new theme
            if (theme === 'vim') {
                document.body.classList.add('vim-theme');
            } else if (theme === 'light') {
                document.body.classList.add('light-theme');
            }
            
            // Update syntax highlighting
            setTimeout(updateEditor, 0);
            elements.statusLeft.textContent = `Theme changed to ${theme}`;
        }

        // Font size controls
        function changeFontSize(delta) {
            currentFontSize = Math.max(10, Math.min(24, currentFontSize + delta));
            
            const size = `${currentFontSize}px`;
            elements.codeInput.style.fontSize = size;
            elements.codeHighlight.style.fontSize = size;
            elements.lineNumbers.style.fontSize = size;
            elements.output.style.fontSize = size;
            
            // Update line height proportionally
            const lineHeight = Math.round(currentFontSize * 1.5);
            elements.codeInput.style.lineHeight = `${lineHeight}px`;
            elements.codeHighlight.style.lineHeight = `${lineHeight}px`;
            elements.lineNumbers.style.lineHeight = `${lineHeight}px`;
            
            updateEditor();
        }

        // Copy output
        function copyOutput() {
            navigator.clipboard.writeText(elements.output.textContent).then(() => {
                elements.statusLeft.textContent = 'Output copied to clipboard';
                setTimeout(() => elements.statusLeft.textContent = 'Ready', 3000);
            }).catch(err => {
                elements.statusLeft.textContent = 'Failed to copy output';
                console.error('Failed to copy:', err);
            });
        }

        // Clear output
        function clearOutput() {
            elements.output.textContent = '';
            if (pyodide) {
                pyodide.runPythonAsync(`
                    sys.stdout.clear()
                    sys.stderr.clear()
                `);
            }
            elements.statusLeft.textContent = 'Output cleared';
        }

        // Load example
        function loadExample() {
            const example = elements.examplesDropdown.value;
            if (example && codeExamples[example]) {
                elements.codeInput.value = codeExamples[example];
                updateEditor();
                elements.statusLeft.textContent = 'Example loaded';
                elements.examplesDropdown.value = '';
            }
        }

        // Load data from URL
        function loadFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const data = urlParams.get('data');
            if (data) {
                try {
                    const parsed = JSON.parse(decodeURIComponent(data));
                    if (parsed.files) {
                        // Clear existing files
                        fileManager.files = {};
                        
                        // Load files
                        Object.keys(parsed.files).forEach(fileName => {
                            fileManager.createFile(fileName, parsed.files[fileName]);
                        });
                        
                        // Set active file
                        if (parsed.active && fileManager.files[parsed.active]) {
                            switchToFile(parsed.active);
                        } else {
                            switchToFile(Object.keys(fileManager.files)[0]);
                        }
                        
                        renderFileTabs();
                        elements.statusLeft.textContent = 'Project loaded from URL';
                    }
                } catch (e) {
                    console.error('Failed to load from URL:', e);
                }
            }
        }

        // Event listeners
        document.getElementById('run-btn').addEventListener('click', runPython);
        document.getElementById('stop-btn').addEventListener('click', stopExecution);
        document.getElementById('save-btn').addEventListener('click', saveCurrentFile);
        document.getElementById('load-btn').addEventListener('click', loadFromFile);
        document.getElementById('export-all-btn').addEventListener('click', exportAllFiles);
        document.getElementById('share-btn').addEventListener('click', shareCode);
        document.getElementById('clear-btn').addEventListener('click', clearOutput);
        document.getElementById('clear-output-btn').addEventListener('click', clearOutput);
        document.getElementById('copy-output-btn').addEventListener('click', copyOutput);
        document.getElementById('new-file-btn').addEventListener('click', createNewFile);
        document.getElementById('increase-font').addEventListener('click', () => changeFontSize(1));
        document.getElementById('decrease-font').addEventListener('click', () => changeFontSize(-1));

        elements.themeSelector.addEventListener('change', () => changeTheme(elements.themeSelector.value));
        elements.examplesDropdown.addEventListener('change', loadExample);
        
        // Editor event listeners
        elements.codeInput.addEventListener('input', updateEditor);
        elements.codeInput.addEventListener('scroll', syncScroll);
        elements.codeInput.addEventListener('keyup', updateCursorStatus);
        elements.codeInput.addEventListener('click', updateCursorStatus);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        runPython();
                        break;
                    case 's':
                        e.preventDefault();
                        saveCurrentFile();
                        break;
                    case 'n':
                        e.preventDefault();
                        createNewFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        loadFromFile();
                        break;
                    case '=':
                    case '+':
                        e.preventDefault();
                        changeFontSize(1);
                        break;
                    case '-':
                        e.preventDefault();
                        changeFontSize(-1);
                        break;
                }
            }
            
            // Tab key for code input
            if (e.target === elements.codeInput && e.key === 'Tab') {
                e.preventDefault();
                const start = elements.codeInput.selectionStart;
                const end = elements.codeInput.selectionEnd;
                
                if (e.shiftKey) {
                    // Shift+Tab: Unindent
                    const lines = elements.codeInput.value.split('\n');
                    const startLine = elements.codeInput.value.substring(0, start).split('\n').length - 1;
                    const endLine = elements.codeInput.value.substring(0, end).split('\n').length - 1;
                    
                    for (let i = startLine; i <= endLine; i++) {
                        if (lines[i].startsWith('    ')) {
                            lines[i] = lines[i].substring(4);
                        }
                    }
                    
                    elements.codeInput.value = lines.join('\n');
                } else {
                    // Tab: Indent
                    elements.codeInput.value = elements.codeInput.value.substring(0, start) + '    ' + elements.codeInput.value.substring(end);
                    elements.codeInput.selectionStart = elements.codeInput.selectionEnd = start + 4;
                }
                
                updateEditor();
            }
        });

        // Initialize everything
        function initialize() {
            fileManager = new FileManager();
            renderFileTabs();
            updateEditor();
            loadFromURL();
            initializePyodide();
            
            // Set initial focus
            elements.codeInput.focus();
            
            console.log('Enhanced Python Editor initialized');
        }

        // Start the application
        initialize();
    </script>
</body>
</html>
