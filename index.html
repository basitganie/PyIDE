<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyTerminal Pro - Full Python IDE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <style>
        :root {
            --bg-void: #0a0e14;
            --bg-surface: #151a21;
            --bg-elevated: #1f2630;
            --bg-overlay: #2a3342;
            
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            
            --border-subtle: #30363d;
            --border-emphasis: #484f58;
            
            --accent-cyan: #58d1eb;
            --accent-green: #3fb950;
            --accent-orange: #ff9e4f;
            --accent-purple: #bc8cff;
            --accent-red: #ff6b6b;
            --accent-yellow: #ffd93d;
            
            --shadow-strong: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--bg-void) 0%, #0d1117 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: grid;
            grid-template-areas:
                "titlebar titlebar"
                "sidebar main"
                "sidebar output";
            grid-template-columns: 300px 1fr;
            grid-template-rows: 50px 1fr 300px;
        }

        /* Titlebar */
        .titlebar {
            grid-area: titlebar;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .titlebar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-logo {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .current-path {
            color: var(--text-secondary);
            font-size: 13px;
            padding: 5px 12px;
            background: var(--bg-surface);
            border-radius: 6px;
        }

        .titlebar-controls {
            display: flex;
            gap: 10px;
        }

        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .path-breadcrumb {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .path-segment {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .path-segment:hover {
            background: var(--bg-overlay);
            color: var(--accent-cyan);
        }

        .sidebar-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .tree-item {
            padding: 8px 12px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: all 0.15s;
            user-select: none;
        }

        .tree-item:hover {
            background: var(--bg-overlay);
        }

        .tree-item.active {
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            color: var(--bg-void);
            font-weight: 600;
        }

        .tree-item.folder {
            font-weight: 500;
            color: var(--accent-orange);
        }

        .tree-item-icon {
            font-size: 16px;
            min-width: 20px;
        }

        .tree-item.folder .tree-item-icon {
            transition: transform 0.2s;
        }

        .tree-item.folder.expanded .tree-item-icon {
            transform: rotate(90deg);
        }

        .tree-item-children {
            margin-left: 25px;
            display: none;
        }

        .tree-item-children.expanded {
            display: block;
        }

        /* Main Editor */
        .main-area {
            grid-area: main;
            background: var(--bg-void);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs-bar {
            display: flex;
            gap: 2px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
            padding: 8px 8px 0 8px;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s;
            min-width: 140px;
        }

        .tab:hover {
            background: var(--bg-overlay);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-void);
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-cyan);
            font-weight: 500;
        }

        .tab-close {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            color: var(--text-muted);
        }

        .tab:hover .tab-close,
        .tab.active .tab-close {
            opacity: 1;
        }

        .tab-close:hover {
            color: var(--accent-red);
        }

        .editor-container {
            flex: 1;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        /* Output Panel */
        .output-panel {
            grid-area: output;
            background: var(--bg-surface);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }

        .output-header {
            padding: 12px 16px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .output-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .output-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--accent-green);
            background: var(--bg-void);
        }

        .output-content .error {
            color: var(--accent-red);
        }

        .output-content .info {
            color: var(--accent-cyan);
        }

        /* Buttons */
        .btn {
            padding: 7px 16px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: var(--bg-void);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--bg-overlay);
            color: var(--text-primary);
            border: 1px solid var(--border-emphasis);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 6px;
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            background: var(--bg-overlay);
            color: var(--text-primary);
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 28px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 11px;
            color: var(--text-muted);
            z-index: 100;
        }

        .status-left, .status-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-emphasis);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-strong);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .input-field {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .input-field:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(88, 209, 235, 0.1);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 48px;
            right: 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-emphasis);
            border-left: 4px solid var(--accent-cyan);
            border-radius: 8px;
            padding: 14px 20px;
            box-shadow: var(--shadow-strong);
            z-index: 3000;
            display: none;
            min-width: 300px;
        }

        .toast.show {
            display: block;
            animation: slideUp 0.3s;
        }

        .toast.error { border-left-color: var(--accent-red); }
        .toast.success { border-left-color: var(--accent-green); }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-overlay);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-overlay);
            border-radius: 5px;
        }

        .context-menu {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--border-emphasis);
            border-radius: 8px;
            padding: 6px;
            box-shadow: var(--shadow-strong);
            z-index: 1000;
            display: none;
            min-width: 180px;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            transition: all 0.15s;
        }

        .context-menu-item:hover {
            background: var(--bg-overlay);
            color: var(--accent-cyan);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Titlebar -->
        <div class="titlebar">
            <div class="titlebar-left">
                <div class="app-logo">‚ö° PyTerminal Pro</div>
                <div class="current-path" id="current-path">/workspace</div>
            </div>
            <div class="titlebar-controls">
                <button class="btn btn-secondary btn-small" onclick="fileSystem.newFile()">üìÑ New File</button>
                <button class="btn btn-secondary btn-small" onclick="fileSystem.newFolder()">üìÅ New Folder</button>
                <button class="btn btn-primary" onclick="executeCode()">‚ñ∂ Run Code</button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">üìÇ File Explorer</div>
                <div class="path-breadcrumb" id="path-breadcrumb"></div>
                <div class="sidebar-actions">
                    <button class="btn btn-secondary btn-small" onclick="fileSystem.navigateUp()">‚¨Ü Up</button>
                    <button class="btn btn-secondary btn-small" onclick="fileSystem.refresh()">üîÑ Refresh</button>
                </div>
            </div>
            <div class="file-tree" id="file-tree"></div>
        </div>

        <!-- Main Editor -->
        <div class="main-area">
            <div class="tabs-bar" id="tabs-bar"></div>
            <div class="editor-container">
                <textarea id="code-editor"></textarea>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="output-panel">
            <div class="output-header">
                <div class="output-title">
                    <span>üñ•Ô∏è Output</span>
                    <span class="loading-spinner" id="execution-spinner" style="display: none;"></span>
                </div>
                <div>
                    <button class="btn-icon" onclick="copyOutput()">üìã</button>
                    <button class="btn-icon" onclick="clearOutput()">üóëÔ∏è</button>
                </div>
            </div>
            <div class="output-content" id="output"></div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span id="status-message">Initializing...</span>
                <span id="line-col-info">Ln 1, Col 1</span>
            </div>
            <div class="status-right">
                <span>Python 3.11</span>
                <span id="file-count">0 files</span>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="contextAction('open')">üìÇ Open</div>
        <div class="context-menu-item" onclick="contextAction('rename')">‚úèÔ∏è Rename</div>
        <div class="context-menu-item" onclick="contextAction('delete')">üóëÔ∏è Delete</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextAction('copy-path')">üìã Copy Path</div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-title" id="modal-title">Title</div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmModal()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"><span id="toast-message"></span></div>

    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

    <!-- Pyodide (loaded separately to avoid cloning issues) -->
    <script>
        let pyodideReadyPromise = null;
        let pyodide = null;

        async function initPyodide() {
            if (pyodideReadyPromise) return pyodideReadyPromise;
            
            pyodideReadyPromise = (async () => {
                try {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
                    
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });

                    pyodide = await loadPyodide({
                        indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/",
                        stdout: (text) => appendOutput(text),
                        stderr: (text) => appendOutput(text, 'error')
                    });

                    // Load numpy
                    await pyodide.loadPackage(['numpy']);

                    return pyodide;
                } catch (error) {
                    console.error('Pyodide init error:', error);
                    throw error;
                }
            })();

            return pyodideReadyPromise;
        }
    </script>

    <script>
        // Global variables
        let editor;
        let modalCallback = null;
        let contextTarget = null;

        // File System Implementation
        class FileSystem {
            constructor() {
                this.files = {
                    '/workspace': {
                        type: 'folder',
                        name: 'workspace',
                        children: {
                            'main.py': {
                                type: 'file',
                                name: 'main.py',
                                content: `# PyTerminal Pro - Full Python IDE
"""
Complete file system with directory navigation
Create files and folders, import modules naturally!
"""

# Import from adjacent module
from utils import greet, calculate

def main():
    print("üöÄ Welcome to PyTerminal Pro!")
    print(greet("Basit"))
    
    # Use imported function
    result = calculate(10, 5)
    print(f"Calculation result: {result}")
    
    # List comprehension
    squares = [x**2 for x in range(1, 6)]
    print(f"Squares: {squares}")

if __name__ == "__main__":
    main()
`
                            },
                            'utils.py': {
                                type: 'file',
                                name: 'utils.py',
                                content: `# Utility Module
"""Helper functions that can be imported"""

def greet(name):
    """Greet someone"""
    return f"Hello, {name}! üëã"

def calculate(a, b):
    """Perform calculation"""
    return a * b + (a - b)

def factorial(n):
    """Calculate factorial"""
    if n <= 1:
        return 1
    return n * factorial(n - 1)

# More utilities
class MathHelper:
    @staticmethod
    def square(x):
        return x ** 2
    
    @staticmethod
    def cube(x):
        return x ** 3
`
                            },
                            'examples': {
                                type: 'folder',
                                name: 'examples',
                                children: {
                                    'hello.py': {
                                        type: 'file',
                                        name: 'hello.py',
                                        content: `# Simple Hello World
print("Hello from examples folder!")

for i in range(5):
    print(f"Count: {i}")
`
                                    }
                                }
                            }
                        }
                    }
                };
                
                this.currentPath = '/workspace';
                this.openTabs = ['/workspace/main.py'];
                this.activeTab = '/workspace/main.py';
            }

            getItem(path) {
                if (path === '/workspace') return this.files['/workspace'];
                
                const parts = path.split('/').filter(p => p);
                let current = this.files['/workspace'];
                
                for (let i = 1; i < parts.length; i++) {
                    if (!current.children || !current.children[parts[i]]) {
                        return null;
                    }
                    current = current.children[parts[i]];
                }
                
                return current;
            }

            getCurrentDir() {
                return this.getItem(this.currentPath);
            }

            listCurrentDir() {
                const dir = this.getCurrentDir();
                if (!dir || dir.type !== 'folder') return [];
                
                return Object.values(dir.children || {}).sort((a, b) => {
                    if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });
            }

            createFile(name, content = '') {
                const dir = this.getCurrentDir();
                if (!dir || dir.type !== 'folder') return false;
                
                if (dir.children[name]) {
                    showToast('File already exists!', 'error');
                    return false;
                }

                dir.children[name] = {
                    type: 'file',
                    name: name,
                    content: content
                };

                this.refresh();
                const fullPath = `${this.currentPath}/${name}`;
                this.openFile(fullPath);
                showToast(`Created ${name}`, 'success');
                return true;
            }

            createFolder(name) {
                const dir = this.getCurrentDir();
                if (!dir || dir.type !== 'folder') return false;
                
                if (dir.children[name]) {
                    showToast('Folder already exists!', 'error');
                    return false;
                }

                dir.children[name] = {
                    type: 'folder',
                    name: name,
                    children: {}
                };

                this.refresh();
                showToast(`Created folder ${name}`, 'success');
                return true;
            }

            deleteItem(path) {
                const parts = path.split('/').filter(p => p);
                const name = parts.pop();
                const parentPath = '/' + parts.join('/');
                const parent = this.getItem(parentPath);
                
                if (!parent || !parent.children || !parent.children[name]) return false;

                delete parent.children[name];
                
                // Close tab if file was open
                this.openTabs = this.openTabs.filter(t => !t.startsWith(path));
                if (this.activeTab === path || this.activeTab.startsWith(path + '/')) {
                    this.activeTab = this.openTabs[0] || null;
                }

                this.refresh();
                renderTabs();
                showToast('Deleted successfully', 'success');
                return true;
            }

            renameItem(path, newName) {
                const parts = path.split('/').filter(p => p);
                const oldName = parts.pop();
                const parentPath = '/' + parts.join('/');
                const parent = this.getItem(parentPath);
                
                if (!parent || !parent.children || !parent.children[oldName]) return false;
                if (parent.children[newName]) {
                    showToast('Name already exists!', 'error');
                    return false;
                }

                const item = parent.children[oldName];
                item.name = newName;
                parent.children[newName] = item;
                delete parent.children[oldName];

                const newPath = `${parentPath}/${newName}`;
                
                // Update open tabs
                this.openTabs = this.openTabs.map(t => 
                    t === path ? newPath : t
                );
                if (this.activeTab === path) {
                    this.activeTab = newPath;
                }

                this.refresh();
                renderTabs();
                showToast(`Renamed to ${newName}`, 'success');
                return true;
            }

            changeDirectory(path) {
                const item = this.getItem(path);
                if (!item || item.type !== 'folder') return false;
                
                this.currentPath = path;
                this.refresh();
                updatePathDisplay();
                return true;
            }

            navigateUp() {
                if (this.currentPath === '/workspace') return;
                
                const parts = this.currentPath.split('/').filter(p => p);
                parts.pop();
                this.currentPath = '/' + parts.join('/');
                
                this.refresh();
                updatePathDisplay();
            }

            openFile(path) {
                const file = this.getItem(path);
                if (!file || file.type !== 'file') return false;

                if (!this.openTabs.includes(path)) {
                    this.openTabs.push(path);
                }
                
                this.activeTab = path;
                editor.setValue(file.content || '');
                
                renderTabs();
                updatePathDisplay();
                return true;
            }

            closeTab(path) {
                this.openTabs = this.openTabs.filter(t => t !== path);
                
                if (this.activeTab === path) {
                    this.activeTab = this.openTabs[this.openTabs.length - 1] || null;
                    if (this.activeTab) {
                        const file = this.getItem(this.activeTab);
                        if (file) editor.setValue(file.content || '');
                    } else {
                        editor.setValue('');
                    }
                }
                
                renderTabs();
            }

            saveCurrentFile() {
                if (!this.activeTab) return false;
                
                const file = this.getItem(this.activeTab);
                if (!file || file.type !== 'file') return false;
                
                file.content = editor.getValue();
                return true;
            }

            refresh() {
                renderFileTree();
                updateFileCount();
            }

            newFile() {
                showModal('Create New File', (name) => {
                    if (name && name.trim()) {
                        const fileName = name.trim();
                        const finalName = fileName.endsWith('.py') ? fileName : fileName + '.py';
                        this.createFile(finalName, '# New Python file\n\n');
                    }
                });
            }

            newFolder() {
                showModal('Create New Folder', (name) => {
                    if (name && name.trim()) {
                        this.createFolder(name.trim());
                    }
                });
            }

            getAllPythonFiles() {
                const files = {};
                
                const traverse = (path, item) => {
                    if (item.type === 'file' && item.name.endsWith('.py')) {
                        files[path] = item.content;
                    } else if (item.type === 'folder' && item.children) {
                        Object.entries(item.children).forEach(([name, child]) => {
                            traverse(`${path}/${name}`, child);
                        });
                    }
                };
                
                traverse('/workspace', this.files['/workspace']);
                return files;
            }
        }

        const fileSystem = new FileSystem();

        // Initialize CodeMirror
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: true,
            extraKeys: {
                'Ctrl-S': () => {
                    fileSystem.saveCurrentFile();
                    showToast('File saved', 'success');
                },
                'Ctrl-Enter': () => executeCode(),
                'Tab': (cm) => {
                    if (cm.somethingSelected()) {
                        cm.indentSelection('add');
                    } else {
                        cm.replaceSelection('    ', 'end');
                    }
                }
            }
        });

        editor.on('change', () => {
            fileSystem.saveCurrentFile();
        });

        editor.on('cursorActivity', () => {
            const cursor = editor.getCursor();
            document.getElementById('line-col-info').textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
        });

        // Render file tree
        function renderFileTree() {
            const tree = document.getElementById('file-tree');
            tree.innerHTML = '';

            const items = fileSystem.listCurrentDir();
            
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'tree-item ' + item.type;
                
                const fullPath = `${fileSystem.currentPath}/${item.name}`;
                
                if (item.type === 'folder') {
                    el.innerHTML = `<span class="tree-item-icon">‚ñ∂</span><span>üìÅ ${item.name}</span>`;
                    el.onclick = () => fileSystem.changeDirectory(fullPath);
                } else {
                    const icon = item.name.endsWith('.py') ? 'üêç' : 'üìÑ';
                    el.innerHTML = `<span class="tree-item-icon">${icon}</span><span>${item.name}</span>`;
                    
                    if (fullPath === fileSystem.activeTab) {
                        el.classList.add('active');
                    }
                    
                    el.onclick = () => fileSystem.openFile(fullPath);
                }

                el.oncontextmenu = (e) => {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, fullPath);
                };

                tree.appendChild(el);
            });
        }

        // Render tabs
        function renderTabs() {
            const tabsBar = document.getElementById('tabs-bar');
            tabsBar.innerHTML = '';

            fileSystem.openTabs.forEach(path => {
                const file = fileSystem.getItem(path);
                if (!file) return;

                const tab = document.createElement('div');
                tab.className = `tab ${path === fileSystem.activeTab ? 'active' : ''}`;
                
                const icon = file.name.endsWith('.py') ? 'üêç' : 'üìÑ';
                const displayPath = path.replace('/workspace/', '');
                
                tab.innerHTML = `
                    <span>${icon} ${displayPath}</span>
                    <span class="tab-close" onclick="event.stopPropagation(); fileSystem.closeTab('${path}')">√ó</span>
                `;

                tab.onclick = () => fileSystem.openFile(path);
                tabsBar.appendChild(tab);
            });
        }

        // Update path display
        function updatePathDisplay() {
            document.getElementById('current-path').textContent = fileSystem.currentPath;
            
            const breadcrumb = document.getElementById('path-breadcrumb');
            const parts = fileSystem.currentPath.split('/').filter(p => p);
            
            breadcrumb.innerHTML = parts.map((part, i) => {
                const path = '/' + parts.slice(0, i + 1).join('/');
                return `<span class="path-segment" onclick="fileSystem.changeDirectory('${path}')">${part}</span>`;
            }).join('<span>/</span>');
        }

        // Update file count
        function updateFileCount() {
            const count = Object.keys(fileSystem.getAllPythonFiles()).length;
            document.getElementById('file-count').textContent = `${count} file${count !== 1 ? 's' : ''}`;
        }

        // Execute Python code
        async function executeCode() {
            document.getElementById('status-message').textContent = 'Running...';
            document.getElementById('execution-spinner').style.display = 'block';
            clearOutput();

            try {
                const py = await initPyodide();
                
                // Get all Python files
                const allFiles = fileSystem.getAllPythonFiles();
                
                appendOutput('üìÅ Loading modules into Python environment...\n', 'info');
                
                // Write all files to Pyodide's filesystem
                for (const [path, content] of Object.entries(allFiles)) {
                    const fileName = path.split('/').pop();
                    try {
                        // Remove existing file if present
                        try {
                            py.FS.unlink('/' + fileName);
                        } catch (e) {
                            // File doesn't exist, that's fine
                        }
                        
                        // Write new file
                        py.FS.writeFile('/' + fileName, content);
                        appendOutput(`  ‚úì Loaded ${fileName}\n`, 'info');
                    } catch (e) {
                        appendOutput(`  ‚úó Failed to load ${fileName}: ${e}\n`, 'error');
                    }
                }
                
                appendOutput('\nüöÄ Executing code...\n\n', 'info');

                // Get current file content
                const code = editor.getValue();
                
                // Execute the code
                await py.runPythonAsync(code);
                
                appendOutput('\n‚úÖ Execution completed\n', 'info');
                document.getElementById('status-message').textContent = 'Ready ‚úì';
                
            } catch (error) {
                appendOutput(`\n‚ùå Error: ${error.message}\n`, 'error');
                document.getElementById('status-message').textContent = 'Error ‚úó';
            } finally {
                document.getElementById('execution-spinner').style.display = 'none';
            }
        }

        // Output functions
        function appendOutput(text, type = 'normal') {
            const output = document.getElementById('output');
            const span = document.createElement('span');
            span.className = type;
            span.textContent = text;
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function copyOutput() {
            const text = document.getElementById('output').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Output copied', 'success');
            });
        }

        // Context menu
        function showContextMenu(x, y, path) {
            const menu = document.getElementById('context-menu');
            contextTarget = path;
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('show');

            const close = (e) => {
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', close);
                }
            };
            
            setTimeout(() => document.addEventListener('click', close), 0);
        }

        function contextAction(action) {
            const menu = document.getElementById('context-menu');
            menu.classList.remove('show');

            if (!contextTarget) return;

            const item = fileSystem.getItem(contextTarget);
            if (!item) return;

            switch (action) {
                case 'open':
                    if (item.type === 'file') {
                        fileSystem.openFile(contextTarget);
                    } else {
                        fileSystem.changeDirectory(contextTarget);
                    }
                    break;
                case 'rename':
                    showModal(`Rename ${item.type}`, (name) => {
                        if (name && name.trim()) {
                            fileSystem.renameItem(contextTarget, name.trim());
                        }
                    }, item.name);
                    break;
                case 'delete':
                    if (confirm(`Delete ${item.name}?`)) {
                        fileSystem.deleteItem(contextTarget);
                    }
                    break;
                case 'copy-path':
                    navigator.clipboard.writeText(contextTarget).then(() => {
                        showToast('Path copied', 'success');
                    });
                    break;
            }

            contextTarget = null;
        }

        // Modal
        function showModal(title, callback, defaultValue = '') {
            const overlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = `<input type="text" class="input-field" id="modal-input" value="${defaultValue}" placeholder="Enter name...">`;
            
            overlay.classList.add('show');
            modalCallback = callback;
            
            setTimeout(() => {
                const input = document.getElementById('modal-input');
                input.focus();
                input.select();
                
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') confirmModal();
                    if (e.key === 'Escape') closeModal();
                };
            }, 100);
        }

        function confirmModal() {
            const input = document.getElementById('modal-input');
            if (modalCallback) modalCallback(input.value);
            closeModal();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
            modalCallback = null;
        }

        // Toast
        function showToast(message, type = 'normal') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            
            toast.className = `toast ${type} show`;
            msg.textContent = message;
            
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Initialize
        window.addEventListener('load', async () => {
            fileSystem.refresh();
            renderTabs();
            updatePathDisplay();
            
            // Load first file
            fileSystem.openFile('/workspace/main.py');
            
            // Initialize Pyodide
            document.getElementById('status-message').textContent = 'Initializing Python...';
            try {
                await initPyodide();
                document.getElementById('status-message').textContent = 'Ready ‚úì';
                showToast('Python initialized successfully!', 'success');
            } catch (error) {
                document.getElementById('status-message').textContent = 'Initialization failed ‚úó';
                showToast('Failed to initialize Python', 'error');
            }
        });
    </script>
</body>
</html>
