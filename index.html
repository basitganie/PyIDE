<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyTerminal - Enhanced Python IDE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #0a0e14;
            --bg-surface: #151a21;
            --bg-elevated: #1f2630;
            --bg-overlay: #2a3342;
            
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            
            --border-subtle: #30363d;
            --border-emphasis: #484f58;
            
            --accent-cyan: #58d1eb;
            --accent-green: #3fb950;
            --accent-orange: #ff9e4f;
            --accent-purple: #bc8cff;
            --accent-red: #ff6b6b;
            --accent-yellow: #ffd93d;
            
            --shadow-strong: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.2);
            
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--bg-void) 0%, #0d1117 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(88, 209, 235, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(188, 140, 255, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            height: 100vh;
            display: grid;
            grid-template-areas:
                "titlebar titlebar"
                "sidebar main"
                "sidebar output";
            grid-template-columns: 280px 1fr;
            grid-template-rows: 48px 1fr 300px;
            position: relative;
            z-index: 1;
        }

        /* Titlebar */
        .titlebar {
            grid-area: titlebar;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            backdrop-filter: blur(12px);
        }

        .titlebar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .current-file-display {
            color: var(--text-secondary);
            font-size: 13px;
            padding: 4px 12px;
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-subtle);
        }

        .titlebar-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Sidebar - File Explorer */
        .sidebar {
            grid-area: sidebar;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-elevated);
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .tree-item {
            padding: 6px 12px;
            margin: 2px 0;
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .tree-item:hover {
            background: var(--bg-overlay);
            transform: translateX(2px);
        }

        .tree-item.active {
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            color: var(--bg-void);
            font-weight: 600;
            box-shadow: var(--shadow-medium);
        }

        .tree-item.folder {
            font-weight: 500;
            color: var(--accent-orange);
        }

        .tree-item.folder.collapsed::before {
            content: '‚ñ∂';
            font-size: 10px;
            margin-right: 4px;
            transition: transform 0.2s;
        }

        .tree-item.folder.expanded::before {
            content: '‚ñº';
            font-size: 10px;
            margin-right: 4px;
            transition: transform 0.2s;
        }

        .tree-item-children {
            margin-left: 20px;
            display: none;
        }

        .tree-item-children.expanded {
            display: block;
        }

        .tree-icon {
            font-size: 16px;
        }

        /* Main Editor Area */
        .main-area {
            grid-area: main;
            background: var(--bg-void);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs-bar {
            display: flex;
            gap: 2px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-subtle);
            padding: 8px 8px 0 8px;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-bottom: none;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s;
            min-width: 120px;
            position: relative;
        }

        .tab:hover {
            background: var(--bg-overlay);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-void);
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-cyan);
            font-weight: 500;
        }

        .tab-close {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 16px;
            color: var(--text-muted);
        }

        .tab:hover .tab-close,
        .tab.active .tab-close {
            opacity: 1;
        }

        .tab-close:hover {
            color: var(--accent-red);
        }

        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #monaco-editor {
            width: 100%;
            height: 100%;
        }

        /* Output Panel */
        .output-panel {
            grid-area: output;
            background: var(--bg-surface);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .output-header {
            padding: 10px 16px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .output-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .output-controls {
            display: flex;
            gap: 6px;
        }

        .output-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--accent-green);
            background: var(--bg-void);
        }

        .output-content .error {
            color: var(--accent-red);
        }

        .output-content .warning {
            color: var(--accent-orange);
        }

        /* Buttons */
        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: var(--bg-void);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .btn-secondary {
            background: var(--bg-overlay);
            color: var(--text-primary);
            border: 1px solid var(--border-emphasis);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-cyan);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-icon {
            padding: 6px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid transparent;
        }

        .btn-icon:hover {
            background: var(--bg-overlay);
            color: var(--text-primary);
            border-color: var(--border-emphasis);
        }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 28px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 11px;
            color: var(--text-muted);
            z-index: 100;
        }

        .status-left, .status-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--border-emphasis);
            border-radius: var(--radius-md);
            padding: 6px;
            box-shadow: var(--shadow-strong);
            z-index: 1000;
            display: none;
            min-width: 180px;
        }

        .context-menu.show {
            display: block;
            animation: contextMenuAppear 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes contextMenuAppear {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-8px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-primary);
            transition: all 0.15s;
        }

        .context-menu-item:hover {
            background: var(--bg-overlay);
            color: var(--accent-cyan);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 4px 0;
        }

        .context-menu-shortcut {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 16px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s;
        }

        .modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-emphasis);
            border-radius: var(--radius-lg);
            padding: 24px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-strong);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .input-field {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(88, 209, 235, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-overlay);
            border-radius: 5px;
            border: 2px solid var(--bg-surface);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-emphasis);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-overlay);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "titlebar"
                    "main"
                    "output";
                grid-template-rows: 48px 1fr 200px;
            }

            .sidebar {
                display: none;
            }
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s;
        }

        .slide-in-left {
            animation: slideInLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Notification Toast */
        .toast {
            position: fixed;
            bottom: 48px;
            right: 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-emphasis);
            border-left: 4px solid var(--accent-cyan);
            border-radius: var(--radius-md);
            padding: 14px 20px;
            box-shadow: var(--shadow-strong);
            z-index: 3000;
            display: none;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            display: flex;
        }

        .toast.error {
            border-left-color: var(--accent-red);
        }

        .toast.success {
            border-left-color: var(--accent-green);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Titlebar -->
        <div class="titlebar">
            <div class="titlebar-left">
                <div class="app-logo">PyTerminal</div>
                <div class="current-file-display" id="current-file-display">/workspace/main.py</div>
            </div>
            <div class="titlebar-controls">
                <button class="btn btn-secondary" onclick="fileSystem.createNewFile()">
                    <span>üìÑ New File</span>
                </button>
                <button class="btn btn-secondary" onclick="fileSystem.createNewFolder()">
                    <span>üìÅ New Folder</span>
                </button>
                <button class="btn btn-primary" onclick="executeCode()">
                    <span>‚ñ∂ Run</span>
                </button>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">File Explorer</div>
                <button class="btn-icon" onclick="fileSystem.refreshTree()" title="Refresh">
                    üîÑ
                </button>
            </div>
            <div class="file-tree" id="file-tree"></div>
        </div>

        <!-- Main Editor -->
        <div class="main-area">
            <div class="tabs-bar" id="tabs-bar"></div>
            <div class="editor-container">
                <div id="monaco-editor"></div>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="output-panel">
            <div class="output-header">
                <div class="output-title">
                    <span>üñ•Ô∏è Output</span>
                    <span class="loading-spinner" id="execution-spinner" style="display: none;"></span>
                </div>
                <div class="output-controls">
                    <button class="btn-icon" onclick="copyOutput()" title="Copy Output">üìã</button>
                    <button class="btn-icon" onclick="clearOutput()" title="Clear Output">üóëÔ∏è</button>
                </div>
            </div>
            <div class="output-content" id="output"></div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span id="status-message">Ready</span>
                </div>
                <div class="status-item">
                    <span id="line-col-info">Ln 1, Col 1</span>
                </div>
            </div>
            <div class="status-right">
                <div class="status-item">Python 3.11</div>
                <div class="status-item">UTF-8</div>
                <div class="status-item" id="file-count">0 files</div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="contextMenuAction('new-file')">
            <span>üìÑ New File</span>
            <span class="context-menu-shortcut">Ctrl+N</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('new-folder')">
            <span>üìÅ New Folder</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('rename')">
            <span>‚úèÔ∏è Rename</span>
            <span class="context-menu-shortcut">F2</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('delete')">
            <span>üóëÔ∏è Delete</span>
            <span class="context-menu-shortcut">Del</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('copy-path')">
            <span>üìã Copy Path</span>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-title" id="modal-title">Modal Title</div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">
                    <span>Cancel</span>
                </button>
                <button class="btn btn-primary" id="modal-confirm-btn" onclick="confirmModal()">
                    <span>Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <script>
        // Global variables
        let editor;
        let pyodide;
        let currentModalCallback = null;
        let contextMenuTarget = null;

        // File System Class
        class FileSystem {
            constructor() {
                this.root = {
                    type: 'folder',
                    name: 'workspace',
                    path: '/workspace',
                    children: {
                        'main.py': {
                            type: 'file',
                            name: 'main.py',
                            path: '/workspace/main.py',
                            content: `# Welcome to PyTerminal - Enhanced Python IDE
"""
Author: Basit Ahmad Ganie
Simulated Linux-like File System
"""

# Example: Import from another file
# from utils import greet

def main():
    print("Hello from PyTerminal!")
    print("This is a simulated Linux file system.")
    print("Create files and folders, import modules!")
    
    # Math example
    for i in range(5):
        print(f"Square of {i}: {i**2}")

if __name__ == "__main__":
    main()
`
                        }
                    }
                };
                this.openTabs = new Set(['/workspace/main.py']);
                this.activeFile = '/workspace/main.py';
                this.fileContents = new Map();
            }

            // Get file/folder by path
            getByPath(path) {
                if (path === '/workspace') return this.root;
                
                const parts = path.split('/').filter(p => p && p !== 'workspace');
                let current = this.root;
                
                for (const part of parts) {
                    if (!current.children || !current.children[part]) {
                        return null;
                    }
                    current = current.children[part];
                }
                
                return current;
            }

            // Create file
            createFile(path, name, content = '') {
                const parent = this.getByPath(path);
                if (!parent || parent.type !== 'folder') return false;
                
                const fullPath = `${path}/${name}`;
                const newFile = {
                    type: 'file',
                    name: name,
                    path: fullPath,
                    content: content
                };
                
                parent.children = parent.children || {};
                parent.children[name] = newFile;
                
                this.fileContents.set(fullPath, content);
                this.refreshTree();
                return fullPath;
            }

            // Create folder
            createFolder(path, name) {
                const parent = this.getByPath(path);
                if (!parent || parent.type !== 'folder') return false;
                
                const fullPath = `${path}/${name}`;
                const newFolder = {
                    type: 'folder',
                    name: name,
                    path: fullPath,
                    children: {}
                };
                
                parent.children = parent.children || {};
                parent.children[name] = newFolder;
                
                this.refreshTree();
                return fullPath;
            }

            // Delete file/folder
            delete(path) {
                const parts = path.split('/').filter(p => p && p !== 'workspace');
                const name = parts.pop();
                const parentPath = '/' + ['workspace', ...parts].join('/');
                
                const parent = this.getByPath(parentPath);
                if (!parent || !parent.children || !parent.children[name]) return false;
                
                delete parent.children[name];
                this.fileContents.delete(path);
                this.openTabs.delete(path);
                
                if (this.activeFile === path) {
                    const remaining = Array.from(this.openTabs);
                    this.activeFile = remaining[0] || '/workspace/main.py';
                }
                
                this.refreshTree();
                return true;
            }

            // Rename file/folder
            rename(oldPath, newName) {
                const parts = oldPath.split('/').filter(p => p && p !== 'workspace');
                const oldName = parts.pop();
                const parentPath = '/' + ['workspace', ...parts].join('/');
                
                const parent = this.getByPath(parentPath);
                if (!parent || !parent.children || !parent.children[oldName]) return false;
                
                const item = parent.children[oldName];
                const newPath = `${parentPath}/${newName}`;
                
                item.name = newName;
                item.path = newPath;
                
                parent.children[newName] = item;
                delete parent.children[oldName];
                
                if (this.fileContents.has(oldPath)) {
                    const content = this.fileContents.get(oldPath);
                    this.fileContents.delete(oldPath);
                    this.fileContents.set(newPath, content);
                }
                
                if (this.openTabs.has(oldPath)) {
                    this.openTabs.delete(oldPath);
                    this.openTabs.add(newPath);
                }
                
                if (this.activeFile === oldPath) {
                    this.activeFile = newPath;
                }
                
                this.refreshTree();
                return newPath;
            }

            // Get file content
            getContent(path) {
                const file = this.getByPath(path);
                if (!file || file.type !== 'file') return null;
                
                if (this.fileContents.has(path)) {
                    return this.fileContents.get(path);
                }
                
                return file.content || '';
            }

            // Set file content
            setContent(path, content) {
                const file = this.getByPath(path);
                if (!file || file.type !== 'file') return false;
                
                this.fileContents.set(path, content);
                file.content = content;
                return true;
            }

            // Open file in editor
            openFile(path) {
                const file = this.getByPath(path);
                if (!file || file.type !== 'file') return false;
                
                this.openTabs.add(path);
                this.activeFile = path;
                
                const content = this.getContent(path);
                editor.setValue(content);
                
                updateCurrentFileDisplay();
                renderTabs();
                return true;
            }

            // Close tab
            closeTab(path) {
                this.openTabs.delete(path);
                
                if (this.activeFile === path) {
                    const remaining = Array.from(this.openTabs);
                    if (remaining.length > 0) {
                        this.openFile(remaining[remaining.length - 1]);
                    } else {
                        this.activeFile = null;
                        editor.setValue('');
                    }
                }
                
                renderTabs();
            }

            // Render file tree
            renderTree() {
                const treeContainer = document.getElementById('file-tree');
                treeContainer.innerHTML = '';
                
                const renderNode = (node, container, level = 0) => {
                    const item = document.createElement('div');
                    item.className = `tree-item ${node.type}`;
                    item.style.paddingLeft = `${level * 12 + 12}px`;
                    
                    if (node.type === 'folder') {
                        item.classList.add('collapsed');
                        item.innerHTML = `<span class="tree-icon">üìÅ</span><span>${node.name}</span>`;
                        
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            item.classList.toggle('collapsed');
                            item.classList.toggle('expanded');
                            childrenContainer.classList.toggle('expanded');
                        });
                    } else {
                        const icon = node.name.endsWith('.py') ? 'üêç' : 'üìÑ';
                        item.innerHTML = `<span class="tree-icon">${icon}</span><span>${node.name}</span>`;
                        
                        if (node.path === this.activeFile) {
                            item.classList.add('active');
                        }
                        
                        item.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.openFile(node.path);
                        });
                    }
                    
                    // Right-click context menu
                    item.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showContextMenu(e.clientX, e.clientY, node.path);
                    });
                    
                    container.appendChild(item);
                    
                    if (node.type === 'folder' && node.children) {
                        const childrenContainer = document.createElement('div');
                        childrenContainer.className = 'tree-item-children';
                        
                        Object.values(node.children)
                            .sort((a, b) => {
                                if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                                return a.name.localeCompare(b.name);
                            })
                            .forEach(child => renderNode(child, childrenContainer, level + 1));
                        
                        container.appendChild(childrenContainer);
                    }
                };
                
                renderNode(this.root, treeContainer);
                updateFileCount();
            }

            refreshTree() {
                this.renderTree();
            }

            // New file dialog
            createNewFile() {
                showModal('Create New File', (name) => {
                    if (name && name.trim()) {
                        const fileName = name.trim().endsWith('.py') ? name.trim() : name.trim() + '.py';
                        const newPath = this.createFile('/workspace', fileName, '# New Python file\n\n');
                        if (newPath) {
                            this.openFile(newPath);
                            showToast(`Created ${fileName}`, 'success');
                        }
                    }
                });
            }

            // New folder dialog
            createNewFolder() {
                showModal('Create New Folder', (name) => {
                    if (name && name.trim()) {
                        const folderPath = this.createFolder('/workspace', name.trim());
                        if (folderPath) {
                            showToast(`Created folder ${name.trim()}`, 'success');
                        }
                    }
                });
            }
        }

        // Initialize file system
        const fileSystem = new FileSystem();

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
        
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: fileSystem.getContent(fileSystem.activeFile),
                language: 'python',
                theme: 'vs-dark',
                fontSize: 14,
                lineNumbers: 'on',
                minimap: { enabled: true },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                tabSize: 4,
                insertSpaces: true,
                wordWrap: 'on',
                contextmenu: true,
                quickSuggestions: true,
                suggestOnTriggerCharacters: true,
                acceptSuggestionOnCommitCharacter: true,
                acceptSuggestionOnEnter: 'on',
                snippetSuggestions: 'inline',
                formatOnPaste: true,
                formatOnType: true
            });

            // Save content on change
            editor.onDidChangeModelContent(() => {
                if (fileSystem.activeFile) {
                    const content = editor.getValue();
                    fileSystem.setContent(fileSystem.activeFile, content);
                }
            });

            // Update cursor position
            editor.onDidChangeCursorPosition(() => {
                const position = editor.getPosition();
                document.getElementById('line-col-info').textContent = `Ln ${position.lineNumber}, Col ${position.column}`;
            });

            // Keyboard shortcuts
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
                saveCurrentFile();
            });

            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {
                executeCode();
            });

            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyN, () => {
                fileSystem.createNewFile();
            });
        });

        // Initialize Pyodide
        async function initPyodide() {
            try {
                document.getElementById('status-message').textContent = 'Initializing Python...';
                
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });

                // Create virtual file system
                await pyodide.runPythonAsync(`
                    import sys
                    import io
                    
                    class OutputCapture:
                        def __init__(self):
                            self.buffer = ""
                        
                        def write(self, text):
                            self.buffer += text
                            return len(text)
                        
                        def flush(self):
                            pass
                        
                        def getvalue(self):
                            return self.buffer
                        
                        def clear(self):
                            self.buffer = ""
                    
                    stdout_capture = OutputCapture()
                    stderr_capture = OutputCapture()
                `);

                await pyodide.loadPackage(['numpy', 'micropip']);
                
                document.getElementById('status-message').textContent = 'Ready';
                showToast('Python initialized successfully', 'success');
            } catch (error) {
                document.getElementById('status-message').textContent = 'Python initialization failed';
                showToast('Failed to initialize Python: ' + error.message, 'error');
            }
        }

        // Execute Python code
        async function executeCode() {
            if (!pyodide) {
                showToast('Python is not initialized yet', 'error');
                return;
            }

            const code = editor.getValue();
            if (!code.trim()) return;

            document.getElementById('status-message').textContent = 'Running...';
            document.getElementById('execution-spinner').style.display = 'block';
            clearOutput();

            try {
                // Load all Python files into Pyodide's virtual filesystem
                const walkFileSystem = (node) => {
                    if (node.type === 'file' && node.name.endsWith('.py')) {
                        const content = fileSystem.getContent(node.path);
                        const moduleName = node.name.replace('.py', '');
                        pyodide.FS.writeFile(`/${moduleName}.py`, content);
                    } else if (node.type === 'folder' && node.children) {
                        Object.values(node.children).forEach(walkFileSystem);
                    }
                };
                
                walkFileSystem(fileSystem.root);

                // Redirect output
                await pyodide.runPythonAsync(`
                    stdout_capture.clear()
                    stderr_capture.clear()
                    sys.stdout = stdout_capture
                    sys.stderr = stderr_capture
                `);

                // Execute code
                await pyodide.runPythonAsync(code);

                // Get output
                const stdout = await pyodide.runPythonAsync(`stdout_capture.getvalue()`);
                const stderr = await pyodide.runPythonAsync(`stderr_capture.getvalue()`);

                if (stdout) {
                    appendOutput(stdout);
                }
                
                if (stderr) {
                    appendOutput(stderr, 'error');
                }

                if (!stdout && !stderr) {
                    appendOutput('Code executed successfully (no output)');
                }

                document.getElementById('status-message').textContent = 'Execution completed';
                
            } catch (error) {
                appendOutput(`Error: ${error.message}`, 'error');
                document.getElementById('status-message').textContent = 'Execution failed';
            } finally {
                document.getElementById('execution-spinner').style.display = 'none';
            }
        }

        // Output functions
        function appendOutput(text, type = 'normal') {
            const outputEl = document.getElementById('output');
            const span = document.createElement('span');
            span.className = type;
            span.textContent = text + '\n';
            outputEl.appendChild(span);
            outputEl.scrollTop = outputEl.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function copyOutput() {
            const output = document.getElementById('output').textContent;
            navigator.clipboard.writeText(output).then(() => {
                showToast('Output copied to clipboard', 'success');
            });
        }

        // Tab management
        function renderTabs() {
            const tabsBar = document.getElementById('tabs-bar');
            tabsBar.innerHTML = '';

            fileSystem.openTabs.forEach(path => {
                const file = fileSystem.getByPath(path);
                if (!file) return;

                const tab = document.createElement('div');
                tab.className = `tab ${path === fileSystem.activeFile ? 'active' : ''}`;
                
                const icon = file.name.endsWith('.py') ? 'üêç' : 'üìÑ';
                tab.innerHTML = `
                    <span class="tree-icon">${icon}</span>
                    <span>${file.name}</span>
                    <span class="tab-close" onclick="event.stopPropagation(); fileSystem.closeTab('${path}')">√ó</span>
                `;

                tab.onclick = () => fileSystem.openFile(path);
                tabsBar.appendChild(tab);
            });
        }

        // Update current file display
        function updateCurrentFileDisplay() {
            document.getElementById('current-file-display').textContent = fileSystem.activeFile || 'No file open';
        }

        // Update file count
        function updateFileCount() {
            let count = 0;
            const countFiles = (node) => {
                if (node.type === 'file') count++;
                if (node.type === 'folder' && node.children) {
                    Object.values(node.children).forEach(countFiles);
                }
            };
            countFiles(fileSystem.root);
            document.getElementById('file-count').textContent = `${count} file${count !== 1 ? 's' : ''}`;
        }

        // Save current file
        function saveCurrentFile() {
            if (!fileSystem.activeFile) return;
            
            const content = editor.getValue();
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            const fileName = fileSystem.activeFile.split('/').pop();
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(a.href);
            
            showToast(`Saved ${fileName}`, 'success');
        }

        // Context menu
        function showContextMenu(x, y, path) {
            const menu = document.getElementById('context-menu');
            contextMenuTarget = path;
            
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.classList.add('show');

            // Close on click outside
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            setTimeout(() => document.addEventListener('click', closeMenu), 0);
        }

        function contextMenuAction(action) {
            const menu = document.getElementById('context-menu');
            menu.classList.remove('show');

            if (!contextMenuTarget) return;

            switch (action) {
                case 'new-file':
                    fileSystem.createNewFile();
                    break;
                case 'new-folder':
                    fileSystem.createNewFolder();
                    break;
                case 'rename':
                    const item = fileSystem.getByPath(contextMenuTarget);
                    if (item) {
                        showModal(`Rename ${item.type}`, (newName) => {
                            if (newName && newName.trim()) {
                                fileSystem.rename(contextMenuTarget, newName.trim());
                                showToast(`Renamed to ${newName.trim()}`, 'success');
                            }
                        }, item.name);
                    }
                    break;
                case 'delete':
                    const toDelete = fileSystem.getByPath(contextMenuTarget);
                    if (toDelete && confirm(`Delete ${toDelete.name}?`)) {
                        fileSystem.delete(contextMenuTarget);
                        showToast(`Deleted ${toDelete.name}`, 'success');
                    }
                    break;
                case 'copy-path':
                    navigator.clipboard.writeText(contextMenuTarget).then(() => {
                        showToast('Path copied to clipboard', 'success');
                    });
                    break;
            }

            contextMenuTarget = null;
        }

        // Modal
        function showModal(title, callback, defaultValue = '') {
            const overlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = `<input type="text" class="input-field" id="modal-input" value="${defaultValue}" placeholder="Enter name...">`;
            
            overlay.classList.add('show');
            
            currentModalCallback = callback;
            
            setTimeout(() => {
                const input = document.getElementById('modal-input');
                input.focus();
                input.select();
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') confirmModal();
                    if (e.key === 'Escape') closeModal();
                });
            }, 100);
        }

        function confirmModal() {
            const input = document.getElementById('modal-input');
            if (currentModalCallback) {
                currentModalCallback(input.value);
            }
            closeModal();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
            currentModalCallback = null;
        }

        // Toast notification
        function showToast(message, type = 'normal') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `toast ${type} show`;
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        saveCurrentFile();
                        break;
                }
            }

            if (e.key === 'F2' && contextMenuTarget) {
                contextMenuAction('rename');
            }
        });

        // Initialize everything
        window.addEventListener('load', () => {
            fileSystem.renderTree();
            renderTabs();
            updateCurrentFileDisplay();
            initPyodide();
        });
    </script>
</body>
</html>
